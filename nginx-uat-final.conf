# UAT环境 Nginx配置 - 最终解决方案

# Client应用代理
location /admin/ {
    rewrite ^/admin/(.*)$ /$1 break;
    proxy_pass http://uat.sigmaq.co.s3-website-ap-southeast-2.amazonaws.com;

    proxy_set_header Host uat.sigmaq.co.s3-website-ap-southeast-2.amazonaws.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 90s;

    # 关键修复：只对非静态资源的404进行拦截
    proxy_intercept_errors on;

    # 使用map来判断是否需要fallback到index.html
    set $fallback "";
    if ($uri !~ \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$) {
        set $fallback "1";
    }

    # 只对非静态资源返回index.html
    error_page 404 = @admin_fallback;
}

# Client fallback处理
location @admin_fallback {
    rewrite ^/admin/(.*)$ /index.html break;
    proxy_pass http://uat.sigmaq.co.s3-website-ap-southeast-2.amazonaws.com;
    proxy_set_header Host uat.sigmaq.co.s3-website-ap-southeast-2.amazonaws.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Super Admin应用代理
location /super-admin/ {
    # 不要重写URL，保持/super-admin/前缀
    proxy_pass http://uat.sigmaq.co.s3-website-ap-southeast-2.amazonaws.com;

    proxy_set_header Host uat.sigmaq.co.s3-website-ap-southeast-2.amazonaws.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 90s;

    # 关键修复：只对非静态资源的404进行拦截
    proxy_intercept_errors on;
    error_page 404 = @superadmin_fallback;
}

# Super Admin fallback处理
location @superadmin_fallback {
    rewrite ^/super-admin/(.*)$ /super-admin/index.html break;
    proxy_pass http://uat.sigmaq.co.s3-website-ap-southeast-2.amazonaws.com;
    proxy_set_header Host uat.sigmaq.co.s3-website-ap-southeast-2.amazonaws.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
