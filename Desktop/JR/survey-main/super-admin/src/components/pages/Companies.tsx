import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import CompanyDetailView from '../companies/CompanyDetailView';

interface Company {
	_id: string;
	name: string;
	email: string;
	slug: string;
	status: string;
	planType: string;
	userCount: number;
	createdAt: string;
	phone?: string;
	website?: string;
	address?:
		| string
		| {
				street?: string;
				city?: string;
				state?: string;
				country?: string;
				postalCode?: string;
		  };
	description?: string;
	maxUsers?: number;
	features?: string[];
	subscription?: {
		startDate: string;
		endDate: string;
		renewalDate: string;
		billingCycle: string;
	};
}

const Companies: React.FC = () => {
	const { companyId } = useParams<{ companyId?: string }>();
	const navigate = useNavigate();
	const [companies, setCompanies] = useState<Company[]>([]);
	const [loading, setLoading] = useState(true);
	const [searchTerm, setSearchTerm] = useState('');
	const [selectedCompany, setSelectedCompany] = useState<Company | null>(null);

	useEffect(() => {
		loadCompanies();
	}, []);

	useEffect(() => {
		// If URL has companyId, load that company
		if (companyId && companies.length > 0) {
			const company = companies.find(c => c._id === companyId);
			if (company) {
				setSelectedCompany(company);
			} else {
				// If company not found in current list, fetch it specifically
				loadCompanyById(companyId);
			}
		}
	}, [companyId, companies]);

	const loadCompanies = async () => {
		setLoading(true);
		try {
			const token = localStorage.getItem('sa_token');
			if (!token) {
				setLoading(false);
				return;
			}

			const response = await fetch('/api/sa/companies', {
				headers: {
					Authorization: `Bearer ${token}`,
				},
			});

			if (response.ok) {
				const data = await response.json();
				if (data.success && data.data) {
					setCompanies(data.data);
				}
			}
		} catch (error) {
			console.log('API not available, showing empty state');
		} finally {
			setLoading(false);
		}
	};

	const loadCompanyById = async (id: string) => {
		try {
			const token = localStorage.getItem('sa_token');
			if (!token) return;

			const response = await fetch(`/api/sa/companies/${id}`, {
				headers: {
					Authorization: `Bearer ${token}`,
				},
			});

			if (response.ok) {
				const contentType = response.headers.get('content-type');
				if (contentType && contentType.includes('application/json')) {
					const data = await response.json();
					if (data.success && data.data) {
						setSelectedCompany(data.data);
					}
				} else {
					console.log('Company API endpoint not available');
					// If company not found, redirect back to list
					navigate('/companies');
				}
			} else {
				console.log('Company not found, redirecting to list');
				navigate('/companies');
			}
		} catch (error) {
			console.log('Error loading company, redirecting to list');
			navigate('/companies');
		}
	};

	const filteredCompanies = companies.filter(
		company =>
			company.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
			company.email.toLowerCase().includes(searchTerm.toLowerCase())
	);

	const handleViewCompany = (company: Company) => {
		navigate(`/companies/${company._id}`);
	};

	const handleBackToList = () => {
		setSelectedCompany(null);
		navigate('/companies');
	};

	const handleUpdateCompany = (updatedCompany: Company) => {
		setCompanies(prev =>
			prev.map(company => (company._id === updatedCompany._id ? updatedCompany : company))
		);
		setSelectedCompany(updatedCompany);
	};

	if (loading) {
		return (
			<div className="flex items-center justify-center h-64">
				<div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
				<span className="ml-2">Loading companies...</span>
			</div>
		);
	}

	// Show detail view if URL has companyId and company is loaded
	if (companyId && selectedCompany) {
		return (
			<CompanyDetailView
				company={selectedCompany}
				onBack={handleBackToList}
				onUpdate={handleUpdateCompany}
			/>
		);
	}

	return (
		<div className="space-y-6">
			{/* Header */}
			<div className="bg-white rounded-lg shadow p-6">
				<div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
					<div>
						<h2 className="text-xl font-semibold text-gray-900">
							Companies Management
						</h2>
						<p className="text-sm text-gray-600 mt-1">
							Manage all companies and their subscriptions
						</p>
					</div>

					<div className="flex flex-col sm:flex-row gap-3">
						<div className="relative">
							<input
								type="text"
								value={searchTerm}
								onChange={e => setSearchTerm(e.target.value)}
								placeholder="Search companies..."
								className="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-64"
							/>
							<svg
								className="absolute left-3 top-2.5 h-5 w-5 text-gray-400"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
								></path>
							</svg>
						</div>

						<button
							onClick={loadCompanies}
							className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
						>
							<svg
								className="w-4 h-4"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
								></path>
							</svg>
							Refresh
						</button>
					</div>
				</div>
			</div>

			{/* Stats */}
			<div className="grid grid-cols-1 md:grid-cols-4 gap-6">
				<div className="bg-white rounded-lg shadow p-6">
					<div className="flex items-center">
						<div className="p-3 rounded-full bg-blue-100 text-blue-600">
							<svg
								className="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
								></path>
							</svg>
						</div>
						<div className="ml-4">
							<p className="text-sm font-medium text-gray-600">Total Companies</p>
							<p className="text-2xl font-semibold text-gray-900">
								{companies.length}
							</p>
						</div>
					</div>
				</div>

				<div className="bg-white rounded-lg shadow p-6">
					<div className="flex items-center">
						<div className="p-3 rounded-full bg-green-100 text-green-600">
							<svg
								className="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
								></path>
							</svg>
						</div>
						<div className="ml-4">
							<p className="text-sm font-medium text-gray-600">Active Companies</p>
							<p className="text-2xl font-semibold text-gray-900">
								{
									companies.filter(
										c => c.status === 'active' || c.status === 'Active'
									).length
								}
							</p>
						</div>
					</div>
				</div>

				<div className="bg-white rounded-lg shadow p-6">
					<div className="flex items-center">
						<div className="p-3 rounded-full bg-yellow-100 text-yellow-600">
							<svg
								className="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5 0a4 4 0 11-8 0 4 4 0 018 0z"
								></path>
							</svg>
						</div>
						<div className="ml-4">
							<p className="text-sm font-medium text-gray-600">Total Users</p>
							<p className="text-2xl font-semibold text-gray-900">
								{companies.reduce((sum, c) => sum + c.userCount, 0)}
							</p>
						</div>
					</div>
				</div>

				<div className="bg-white rounded-lg shadow p-6">
					<div className="flex items-center">
						<div className="p-3 rounded-full bg-purple-100 text-purple-600">
							<svg
								className="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
								></path>
							</svg>
						</div>
						<div className="ml-4">
							<p className="text-sm font-medium text-gray-600">Revenue</p>
							<p className="text-2xl font-semibold text-gray-900">$0</p>
						</div>
					</div>
				</div>
			</div>

			{/* Companies Table */}
			<div className="bg-white rounded-lg shadow overflow-hidden">
				<div className="px-6 py-4 border-b border-gray-200">
					<h3 className="text-lg font-medium text-gray-900">Companies List</h3>
				</div>

				{filteredCompanies.length === 0 ? (
					<div className="p-8 text-center">
						<svg
							className="mx-auto h-12 w-12 text-gray-400"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								strokeLinecap="round"
								strokeLinejoin="round"
								strokeWidth="2"
								d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
							></path>
						</svg>
						<h3 className="mt-2 text-sm font-medium text-gray-900">
							No companies found
						</h3>
						<p className="mt-1 text-sm text-gray-500">
							{searchTerm
								? 'No companies match your search.'
								: 'No companies have been registered yet.'}
						</p>
					</div>
				) : (
					<div className="overflow-x-auto">
						<table className="min-w-full divide-y divide-gray-200">
							<thead className="bg-gray-50">
								<tr>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
										Company
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
										Slug
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
										Plan
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
										Status
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
										Users
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
										Created
									</th>
									<th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
										Actions
									</th>
								</tr>
							</thead>
							<tbody className="bg-white divide-y divide-gray-200">
								{filteredCompanies.map(company => (
									<tr key={company._id}>
										<td className="px-6 py-4 whitespace-nowrap">
											<div className="flex items-center">
												<div className="flex-shrink-0 h-10 w-10">
													<div className="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
														<span className="text-sm font-medium text-gray-700">
															{company.name.charAt(0).toUpperCase()}
														</span>
													</div>
												</div>
												<div className="ml-4">
													<button
														onClick={() => handleViewCompany(company)}
														className="text-sm font-medium text-gray-900 hover:text-blue-600 text-left"
													>
														{company.name}
													</button>
													<div className="text-sm text-gray-500">
														{company.email}
													</div>
												</div>
											</div>
										</td>
										<td className="px-6 py-4 whitespace-nowrap">
											<div className="text-sm text-gray-900 font-mono">
												{company.slug || 'N/A'}
											</div>
										</td>
										<td className="px-6 py-4 whitespace-nowrap">
											<span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
												{company.planType || 'Free'}
											</span>
										</td>
										<td className="px-6 py-4 whitespace-nowrap">
											<span
												className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
													company.status === 'active'
														? 'bg-green-100 text-green-800'
														: 'bg-red-100 text-red-800'
												}`}
											>
												{company.status}
											</span>
										</td>
										<td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
											{company.userCount}
										</td>
										<td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
											{new Date(company.createdAt).toLocaleDateString()}
										</td>
										<td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
											<button
												onClick={() => handleViewCompany(company)}
												className="text-blue-600 hover:text-blue-900 mr-3"
											>
												View
											</button>
											<button
												onClick={() => {
													// Handle suspend/activate directly from list
													const newStatus =
														company.status === 'active'
															? 'suspended'
															: 'active';
													fetch(
														`/api/sa/companies/${company._id}/status`,
														{
															method: 'PUT',
															headers: {
																'Content-Type': 'application/json',
																Authorization: `Bearer ${localStorage.getItem('sa_token')}`,
															},
															body: JSON.stringify({
																status: newStatus,
															}),
														}
													).then(() => {
														setCompanies(prev =>
															prev.map(c =>
																c._id === company._id
																	? { ...c, status: newStatus }
																	: c
															)
														);
													});
												}}
												className={
													company.status === 'active'
														? 'text-red-600 hover:text-red-900'
														: 'text-green-600 hover:text-green-900'
												}
											>
												{company.status === 'active'
													? 'Suspend'
													: 'Activate'}
											</button>
										</td>
									</tr>
								))}
							</tbody>
						</table>
					</div>
				)}
			</div>
		</div>
	);
};

export default Companies;
