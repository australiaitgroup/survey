import React, { useState, useEffect } from 'react';

interface AuditLog {
	_id: string;
	action: string;
	resource: string;
	resourceId: string;
	userId: string;
	userName: string;
	userEmail: string;
	details: any;
	ipAddress: string;
	userAgent: string;
	timestamp: string;
	level: 'info' | 'warning' | 'error';
}

const Audit: React.FC = () => {
	const [auditLogs, setAuditLogs] = useState<AuditLog[]>([]);
	const [loading, setLoading] = useState(true);
	const [searchTerm, setSearchTerm] = useState('');
	const [filterAction, setFilterAction] = useState('');
	const [filterLevel, setFilterLevel] = useState('');
	const [currentPage, setCurrentPage] = useState(1);
	const logsPerPage = 50;

	useEffect(() => {
		loadAuditLogs();
	}, []);

	const loadAuditLogs = async () => {
		setLoading(true);
		try {
			const token = localStorage.getItem('sa_token');
			if (!token) {
				setLoading(false);
				return;
			}

			const params = new URLSearchParams({
				page: currentPage.toString(),
				limit: logsPerPage.toString(),
			});

			if (searchTerm) params.append('search', searchTerm);
			if (filterAction) params.append('action', filterAction);
			if (filterLevel) params.append('level', filterLevel);

			const response = await fetch(`/api/sa/audit-logs?${params}`, {
				headers: {
					Authorization: `Bearer ${token}`,
				},
			});

			if (response.ok) {
				const data = await response.json();
				if (data.success && data.data) {
					setAuditLogs(data.data);
				}
			}
		} catch (error) {
			console.log('API not available, showing empty state');
		} finally {
			setLoading(false);
		}
	};

	const filteredLogs = auditLogs.filter(log => {
		let matches = true;

		if (searchTerm) {
			matches =
				log.action.toLowerCase().includes(searchTerm.toLowerCase()) ||
				log.resource.toLowerCase().includes(searchTerm.toLowerCase()) ||
				log.userName.toLowerCase().includes(searchTerm.toLowerCase()) ||
				log.userEmail.toLowerCase().includes(searchTerm.toLowerCase());
		}

		if (filterAction && log.action !== filterAction) {
			matches = false;
		}

		if (filterLevel && log.level !== filterLevel) {
			matches = false;
		}

		return matches;
	});

	const getActionIcon = (action: string) => {
		switch (action.toLowerCase()) {
		case 'create':
			return (
				<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path
						strokeLinecap="round"
						strokeLinejoin="round"
						strokeWidth="2"
						d="M12 6v6m0 0v6m0-6h6m-6 0H6"
					></path>
				</svg>
			);
		case 'update':
			return (
				<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path
						strokeLinecap="round"
						strokeLinejoin="round"
						strokeWidth="2"
						d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
					></path>
				</svg>
			);
		case 'delete':
			return (
				<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path
						strokeLinecap="round"
						strokeLinejoin="round"
						strokeWidth="2"
						d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
					></path>
				</svg>
			);
		case 'login':
			return (
				<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path
						strokeLinecap="round"
						strokeLinejoin="round"
						strokeWidth="2"
						d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"
					></path>
				</svg>
			);
		default:
			return (
				<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path
						strokeLinecap="round"
						strokeLinejoin="round"
						strokeWidth="2"
						d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
					></path>
				</svg>
			);
		}
	};

	const getLevelBadge = (level: string) => {
		switch (level) {
		case 'error':
			return 'bg-red-100 text-red-800';
		case 'warning':
			return 'bg-yellow-100 text-yellow-800';
		default:
			return 'bg-blue-100 text-blue-800';
		}
	};

	if (loading) {
		return (
			<div className="flex items-center justify-center h-64">
				<div className="text-center">
					<div className="animate-spin rounded-full h-8 w-8 border-2 border-blue-500 border-t-transparent mx-auto mb-4"></div>
					<p className="text-gray-600">Loading audit logs...</p>
				</div>
			</div>
		);
	}

	return (
		<div className="space-y-6">
			{/* Header */}
			<div className="bg-white rounded-lg shadow p-6">
				<div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
					<div>
						<h2 className="text-xl font-semibold text-gray-900">
							Audit Log Management
						</h2>
						<p className="text-sm text-gray-600 mt-1">
							Monitor all system activities and user actions
						</p>
					</div>

					<div className="flex flex-col sm:flex-row gap-3">
						<div className="relative">
							<input
								type="text"
								value={searchTerm}
								onChange={e => setSearchTerm(e.target.value)}
								placeholder="Search audit logs..."
								className="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-64"
							/>
							<svg
								className="absolute left-3 top-2.5 h-5 w-5 text-gray-400"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
								></path>
							</svg>
						</div>

						<select
							value={filterAction}
							onChange={e => setFilterAction(e.target.value)}
							className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
						>
							<option value="">All Actions</option>
							<option value="create">Create</option>
							<option value="update">Update</option>
							<option value="delete">Delete</option>
							<option value="login">Login</option>
							<option value="logout">Logout</option>
						</select>

						<select
							value={filterLevel}
							onChange={e => setFilterLevel(e.target.value)}
							className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
						>
							<option value="">All Levels</option>
							<option value="info">Info</option>
							<option value="warning">Warning</option>
							<option value="error">Error</option>
						</select>

						<button
							onClick={loadAuditLogs}
							className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
						>
							<svg
								className="w-4 h-4"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
								></path>
							</svg>
							Refresh
						</button>
					</div>
				</div>
			</div>

			{/* Stats */}
			<div className="grid grid-cols-1 md:grid-cols-4 gap-6">
				<div className="bg-white rounded-lg shadow p-6">
					<div className="flex items-center">
						<div className="p-3 rounded-full bg-blue-100 text-blue-600">
							<svg
								className="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
								></path>
							</svg>
						</div>
						<div className="ml-4">
							<p className="text-sm font-medium text-gray-600">Total Logs</p>
							<p className="text-2xl font-semibold text-gray-900">
								{auditLogs.length}
							</p>
						</div>
					</div>
				</div>

				<div className="bg-white rounded-lg shadow p-6">
					<div className="flex items-center">
						<div className="p-3 rounded-full bg-green-100 text-green-600">
							<svg
								className="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
								></path>
							</svg>
						</div>
						<div className="ml-4">
							<p className="text-sm font-medium text-gray-600">Info</p>
							<p className="text-2xl font-semibold text-gray-900">
								{auditLogs.filter(log => log.level === 'info').length}
							</p>
						</div>
					</div>
				</div>

				<div className="bg-white rounded-lg shadow p-6">
					<div className="flex items-center">
						<div className="p-3 rounded-full bg-yellow-100 text-yellow-600">
							<svg
								className="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
								></path>
							</svg>
						</div>
						<div className="ml-4">
							<p className="text-sm font-medium text-gray-600">Warnings</p>
							<p className="text-2xl font-semibold text-gray-900">
								{auditLogs.filter(log => log.level === 'warning').length}
							</p>
						</div>
					</div>
				</div>

				<div className="bg-white rounded-lg shadow p-6">
					<div className="flex items-center">
						<div className="p-3 rounded-full bg-red-100 text-red-600">
							<svg
								className="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
								></path>
							</svg>
						</div>
						<div className="ml-4">
							<p className="text-sm font-medium text-gray-600">Errors</p>
							<p className="text-2xl font-semibold text-gray-900">
								{auditLogs.filter(log => log.level === 'error').length}
							</p>
						</div>
					</div>
				</div>
			</div>

			{/* Audit Logs Table */}
			<div className="bg-white rounded-lg shadow overflow-hidden">
				<div className="px-6 py-4 border-b border-gray-200">
					<h3 className="text-lg font-medium text-gray-900">Recent Activity</h3>
				</div>

				{filteredLogs.length === 0 ? (
					<div className="p-8 text-center">
						<svg
							className="mx-auto h-12 w-12 text-gray-400"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								strokeLinecap="round"
								strokeLinejoin="round"
								strokeWidth="2"
								d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
							></path>
						</svg>
						<h3 className="mt-2 text-sm font-medium text-gray-900">
							No audit logs found
						</h3>
						<p className="mt-1 text-sm text-gray-500">
							{searchTerm
								? 'No logs match your search criteria.'
								: 'No audit logs have been recorded yet.'}
						</p>
					</div>
				) : (
					<div className="divide-y divide-gray-200">
						{filteredLogs.map(log => (
							<div key={log._id} className="p-6">
								<div className="flex items-start justify-between">
									<div className="flex items-start space-x-3">
										<div
											className={`p-1 rounded-full ${getLevelBadge(log.level)}`}
										>
											{getActionIcon(log.action)}
										</div>
										<div className="flex-1 min-w-0">
											<div className="flex items-center gap-2 mb-1">
												<p className="text-sm font-medium text-gray-900">
													{log.userName} performed {log.action} on{' '}
													{log.resource}
												</p>
												<span
													className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getLevelBadge(log.level)}`}
												>
													{log.level}
												</span>
											</div>
											<p className="text-sm text-gray-500 mb-2">
												{log.userEmail} • {log.ipAddress}
											</p>
											{log.details && Object.keys(log.details).length > 0 && (
												<div className="text-xs text-gray-600 bg-gray-50 rounded p-2 max-w-2xl">
													<pre className="whitespace-pre-wrap font-mono">
														{JSON.stringify(log.details, null, 2)}
													</pre>
												</div>
											)}
										</div>
									</div>
									<div className="text-right text-sm text-gray-500">
										<p>{new Date(log.timestamp).toLocaleDateString()}</p>
										<p>{new Date(log.timestamp).toLocaleTimeString()}</p>
									</div>
								</div>
							</div>
						))}
					</div>
				)}
			</div>
		</div>
	);
};

export default Audit;
