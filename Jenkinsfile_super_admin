pipeline {
    agent any

    environment {
        // Application configuration
        APP_NAME = 'survey-super-admin'
        NODE_VERSION = '18'

        // S3 Configuration - these are hardcoded since AWS creds come from Vault
        S3_BUCKET_NAME = 'sigma.jiangren.com.au'
        AWS_REGION = 'ap-southeast-2'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }

        // TEMP STAGE: Bucket bootstrap (remove after first successful run)
        stage('Prepare S3 Bucket') {
            steps {
                echo 'Ensuring S3 bucket exists and is configured (temporary stage)...'
                withVault(configuration: [timeout: 60, vaultCredentialId: 'Vault Credential', vaultUrl: 'https://vault.jiangren.com.au'], vaultSecrets: [[path: 'secret_aws/aws_prod', secretValues: [[vaultKey: 'AWS_ACCESS_KEY_ID'], [vaultKey: 'AWS_SECRET_ACCESS_KEY']]]]) {
                    sh '''
set -e

echo "🔍 Checking if bucket ${S3_BUCKET_NAME} exists..."
if aws s3api head-bucket --bucket ${S3_BUCKET_NAME} 2>/dev/null; then
  echo "✅ Bucket already exists"
else
  echo "🪣 Creating bucket ${S3_BUCKET_NAME} in ${AWS_REGION}..."
  aws s3api create-bucket --bucket ${S3_BUCKET_NAME} --region ${AWS_REGION} --create-bucket-configuration LocationConstraint=${AWS_REGION}
  echo "✅ Bucket created"
fi

echo "🔐 Adjusting public access block (allow policy usage)..."
aws s3api put-public-access-block --bucket ${S3_BUCKET_NAME} \
  --public-access-block-configuration BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false

echo "🌐 Configuring static website hosting..."
aws s3 website s3://${S3_BUCKET_NAME}/ --index-document index.html --error-document index.html || true

echo "🔎 Checking existing bucket policy..."
if aws s3api get-bucket-policy --bucket ${S3_BUCKET_NAME} >/dev/null 2>&1; then
  echo "⚠️  Policy already set - skipping apply (remove this stage later)"
else
  echo "📝 Applying minimal read-only policy for /super-admin prefix..."
  POLICY_FILE=$(mktemp)
  cat > $POLICY_FILE <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadSuperAdmin",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::${S3_BUCKET_NAME}/super-admin/*"
    }
  ]
}
EOF
  aws s3api put-bucket-policy --bucket ${S3_BUCKET_NAME} --policy file://$POLICY_FILE
  rm -f $POLICY_FILE
  echo "✅ Policy applied"
fi

echo "📄 Bucket website endpoint (may 404 until first deploy): http://${S3_BUCKET_NAME}.s3-website-${AWS_REGION}.amazonaws.com/super-admin"
'''
                }
            }
        }

        stage('Setup Node.js') {
            steps {
                echo 'Setting up Node.js environment...'
                sh '''
                    # Check Node.js version
                    node --version
                    npm --version
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'Installing Super Admin dependencies...'
                dir('super-admin') {
                    sh '''
                        # Clean install to ensure consistency
                        rm -rf node_modules package-lock.json
                        npm install
                    '''
                }
            }
        }

        stage('Build Super Admin') {
            steps {
                echo 'Building Super Admin application...'
                dir('super-admin') {
                    sh '''
                        # Build for production
                        NODE_ENV=production npm run build

                        # Verify build output
                        if [ ! -d "dist" ]; then
                            echo "❌ Build failed - dist directory not found"
                            exit 1
                        fi

                        echo "✅ Build completed successfully"
                        echo "Build contents:"
                        ls -la dist/
                    '''
                }
            }
        }

        stage('Deploy to S3') {
            steps {
                echo 'Deploying Super Admin to S3...'
                withVault(configuration: [timeout: 60, vaultCredentialId: 'Vault Credential', vaultUrl: 'https://vault.jiangren.com.au'], vaultSecrets: [[path: 'secret_aws/aws_prod', secretValues: [[vaultKey: 'AWS_ACCESS_KEY_ID'], [vaultKey: 'AWS_SECRET_ACCESS_KEY']]]]) {
                    dir('super-admin') {
                        sh '''
                            echo "🚀 Starting S3 deployment..."

                            # Sync files to S3 with proper cache headers
                            echo "Uploading static assets..."
                            aws s3 sync dist/ s3://${S3_BUCKET_NAME}/super-admin/ \
                                --region ${AWS_REGION} \
                                --delete \
                                --cache-control "public, max-age=31536000" \
                                --exclude "*.html" \
                                --exclude "*.json"

                            # Upload HTML and JSON files with no-cache headers
                            echo "Uploading HTML and JSON files..."
                            aws s3 sync dist/ s3://${S3_BUCKET_NAME}/super-admin/ \
                                --region ${AWS_REGION} \
                                --include "*.html" \
                                --include "*.json" \
                                --cache-control "no-cache, no-store, must-revalidate"

                            # Set specific content type for index.html
                            aws s3 cp s3://${S3_BUCKET_NAME}/super-admin/index.html \
                                s3://${S3_BUCKET_NAME}/super-admin/index.html \
                                --region ${AWS_REGION} \
                                --content-type "text/html" \
                                --cache-control "no-cache, no-store, must-revalidate" \
                                --metadata-directive REPLACE

                            echo "✅ S3 deployment completed!"
                        '''
                    }
                }
            }
        }

        stage('Health Check') {
            steps {
                echo 'Performing deployment health check...'
                script {
                    // Wait a bit for S3 to update
                    sleep 10

                    sh '''
                        # You can add health checks here if you have a specific endpoint
                        echo "✅ Deployment health check completed"
                        echo "Super Admin should be available at: http://${S3_BUCKET_NAME}.s3-website-${AWS_REGION}.amazonaws.com/super-admin"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed'
            // Skip cleanWs due to Jenkins environment context issues
            echo 'Workspace cleanup skipped due to environment limitations'
        }
        success {
            echo '🎉 Super Admin deployment successful!'
            echo 'Application deployed to: http://${S3_BUCKET_NAME}.s3-website-${AWS_REGION}.amazonaws.com/super-admin'
            // You can add success notifications here (Slack, email, etc.)
        }
        failure {
            echo '❌ Super Admin deployment failed!'
            echo 'ERROR: Check Jenkins credentials configuration'
            echo 'Required credentials: aws-credentials, S3_BUCKET_NAME, AWS_REGION'
            // You can add failure notifications here
        }
    }
}
