# Nginx 配置：支持主前端和 Super Admin 的 S3 反向代理
# 添加到 uat-sigma.jiangren.com.au 的 server 块中

# 重要：location 顺序很关键！API 必须在根路径之前

# 1. API 路由 - 最高优先级，代理到后端 EC2
location /api/ {
    include /etc/nginx/proxy_params;
    proxy_pass http://localhost:5050/api/;
    proxy_read_timeout 90s;
    proxy_redirect off;
}

# 2. Super Admin 路由 - 代理到 S3 子路径
location /super-admin/ {
    include /etc/nginx/proxy_params;
    proxy_pass http://uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com/super-admin/;
    proxy_set_header Host uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com;
    proxy_read_timeout 90s;
    proxy_redirect off;

    # 缓存静态资源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com;
        proxy_set_header Host uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# 3. 主前端路由 - 代理到 S3 根路径（最低优先级）
location / {
    include /etc/nginx/proxy_params;
    proxy_pass http://uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com/;
    proxy_set_header Host uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com;
    proxy_read_timeout 90s;
    proxy_redirect off;

    # React Router 支持 - 所有未匹配的路由都返回 index.html
    try_files $uri $uri/ @fallback;

    # 缓存静态资源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com;
        proxy_set_header Host uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# 4. React Router 后备 - 处理 SPA 路由
location @fallback {
    proxy_pass http://uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com/;
    proxy_set_header Host uat-sigma.jiangren.com.au.s3-website-ap-southeast-2.amazonaws.com;
    proxy_redirect off;
}
