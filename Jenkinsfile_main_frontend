pipeline {
    agent any

    environment {
        // Application configuration
        APP_NAME = 'sigma-main-frontend'
        NODE_VERSION = '18'

        // S3 Configuration - using existing bucket
        S3_BUCKET_NAME = 'uat-sigma.jiangren.com.au'
        AWS_REGION = 'ap-southeast-2'
        
        // S3 Static Website URL
        S3_WEBSITE_URL = "http://${S3_BUCKET_NAME}.s3-website-${AWS_REGION}.amazonaws.com"
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }

        stage('Setup Node.js') {
            steps {
                echo 'Setting up Node.js environment...'
                sh '''
                    # Check Node.js version
                    node --version
                    npm --version
                '''
            }
        }

        stage('Update S3 Bucket Policy') {
            steps {
                echo 'Updating S3 bucket policy to support both main app and super-admin...'
                withVault(configuration: [timeout: 60, vaultCredentialId: 'Vault Credential', vaultUrl: 'https://vault.jiangren.com.au'], vaultSecrets: [[path: 'secret_aws/aws_prod', secretValues: [[vaultKey: 'AWS_ACCESS_KEY_ID'], [vaultKey: 'AWS_SECRET_ACCESS_KEY']]]]) {
                    sh '''
set -e

echo "ðŸ“ Applying expanded bucket policy for main app and super-admin..."
POLICY_FILE=$(mktemp)
cat > $POLICY_FILE <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadSuperAdmin",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::${S3_BUCKET_NAME}/super-admin/*"
    },
    {
      "Sid": "PublicReadMainApp",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::${S3_BUCKET_NAME}/*"
    }
  ]
}
EOF

aws s3api put-bucket-policy --bucket ${S3_BUCKET_NAME} --policy file://$POLICY_FILE
rm -f $POLICY_FILE

echo "âœ… Bucket policy updated successfully"
echo "Now supports:"
echo "  - Root path access: arn:aws:s3:::${S3_BUCKET_NAME}/*"
echo "  - Super Admin path: arn:aws:s3:::${S3_BUCKET_NAME}/super-admin/*"
'''
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'Installing main frontend dependencies...'
                dir('client') {
                    sh '''
                        # Clean install to ensure consistency
                        rm -rf node_modules package-lock.json
                        npm install
                    '''
                }
            }
        }

        stage('Build Main Frontend') {
            steps {
                echo 'Building main frontend application...'
                dir('client') {
                    sh '''
                        # Build for production
                        NODE_ENV=production npm run build

                        # Verify build output
                        if [ ! -d "dist" ]; then
                            echo "âŒ Build failed - dist directory not found"
                            exit 1
                        fi

                        echo "âœ… Build completed successfully"
                        echo "Build contents:"
                        ls -la dist/
                    '''
                }
            }
        }

        stage('Deploy Main Frontend to S3') {
            steps {
                echo 'Deploying main frontend to S3 root path...'
                withVault(configuration: [timeout: 60, vaultCredentialId: 'Vault Credential', vaultUrl: 'https://vault.jiangren.com.au'], vaultSecrets: [[path: 'secret_aws/aws_prod', secretValues: [[vaultKey: 'AWS_ACCESS_KEY_ID'], [vaultKey: 'AWS_SECRET_ACCESS_KEY']]]]) {
                    dir('client') {
                        sh '''
                            echo "ðŸš€ Starting main frontend S3 deployment..."

                            # Create exclusion patterns to avoid overwriting super-admin
                            echo "âš ï¸  Excluding super-admin directory from deployment..."
                            
                            # Sync files to S3 root with proper cache headers, excluding super-admin
                            echo "Uploading static assets to root path..."
                            aws s3 sync dist/ s3://${S3_BUCKET_NAME}/ \
                                --region ${AWS_REGION} \
                                --delete \
                                --exclude "super-admin/*" \
                                --cache-control "public, max-age=31536000" \
                                --exclude "*.html" \
                                --exclude "*.json"

                            # Upload HTML and JSON files with no-cache headers
                            echo "Uploading HTML and JSON files to root path..."
                            aws s3 sync dist/ s3://${S3_BUCKET_NAME}/ \
                                --region ${AWS_REGION} \
                                --exclude "super-admin/*" \
                                --include "*.html" \
                                --include "*.json" \
                                --cache-control "no-cache, no-store, must-revalidate"

                            # Set specific content type for index.html
                            aws s3 cp s3://${S3_BUCKET_NAME}/index.html \
                                s3://${S3_BUCKET_NAME}/index.html \
                                --region ${AWS_REGION} \
                                --content-type "text/html" \
                                --cache-control "no-cache, no-store, must-revalidate" \
                                --metadata-directive REPLACE

                            echo "âœ… Main frontend S3 deployment completed!"
                            echo "ðŸ“„ Verifying super-admin directory was not affected..."
                            aws s3 ls s3://${S3_BUCKET_NAME}/super-admin/ --recursive | head -5 || echo "Super-admin directory check complete"
                        '''
                    }
                }
            }
        }

        stage('Health Check') {
            steps {
                echo 'Performing main frontend deployment health check...'
                script {
                    // Wait a bit for S3 to update
                    sleep 10

                    sh '''
                        echo "âœ… Main frontend deployment health check completed"
                        echo "Main frontend should be available at: ${S3_WEBSITE_URL}"
                        echo "Super Admin should still be available at: ${S3_WEBSITE_URL}/super-admin"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Main frontend pipeline completed'
            echo 'Workspace cleanup skipped due to environment limitations'
        }
        success {
            echo 'ðŸŽ‰ Main frontend deployment successful!'
            echo 'Main application deployed to: ${S3_WEBSITE_URL}'
            echo 'Super Admin remains at: ${S3_WEBSITE_URL}/super-admin'
        }
        failure {
            echo 'âŒ Main frontend deployment failed!'
            echo 'ERROR: Check Jenkins credentials and build configuration'
        }
    }
}
